<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chatbot Espa√±ol I - Atlas Language Academy</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Roboto Slab', serif;
      background-color: #F3EFE3;
      color: #A84339;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      justify-content: center;
      align-items: center;
    }
    h1 {
      margin: 20px 0 10px 0;
      color: #CB9180;
    }
    #voice-select {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;
    }
    #voice-select button {
      border: none;
      cursor: pointer;
      padding: 5px 10px;
      background: transparent;
      transition: transform 0.2s ease;
    }
    #voice-select button:hover {
      transform: scale(1.1);
    }
    #voice-select img {
      width: 35px;
      height: 25px;
      border-radius: 5px;
      border: 2px solid transparent;
      box-shadow: 0 0 5px rgba(168,67,57,0.3);
    }
    #voice-select button.selected img {
      border-color: #CB9180;
      box-shadow: 0 0 12px #CB9180;
    }
    #chat-container {
      width: 90%;
      max-width: 500px;
      height: 450px;
      background-color: white;
      border: 3px solid #CB9180;
      border-radius: 15px;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(184, 121, 96, 0.5);
    }
    #chat {
      flex-grow: 1;
      overflow-y: auto;
      padding-right: 10px;
      margin-bottom: 15px;
    }
    .message {
      margin-bottom: 15px;
      line-height: 1.4;
    }
    .bot-message {
      color: #A84339;
      font-weight: 600;
    }
    .user-message {
      color: #CB9180;
      font-style: italic;
      text-align: right;
    }
    #start-btn {
      background-color: #CB9180;
      border: none;
      padding: 12px 20px;
      color: white;
      font-size: 1rem;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-weight: 700;
    }
    #start-btn:hover {
      background-color: #A84339;
    }
    #feedback {
      color: #A84339;
      font-weight: 600;
      margin-bottom: 10px;
      min-height: 24px;
    }
  </style>
</head>
<body>
  <h1>Chatbot Espa√±ol I</h1>

  <div id="voice-select" aria-label="Select Spanish Accent">
    <button id="es-ES" title="Espa√±ol Espa√±a" class="selected" aria-pressed="true">
      <img src="https://flagcdn.com/w40/es.png" alt="Bandera de Espa√±a" />
    </button>
    <button id="es-MX" title="Espa√±ol Latinoam√©rica" aria-pressed="false">
      <img src="https://flagcdn.com/w40/mx.png" alt="Bandera de M√©xico" />
    </button>
  </div>

  <div id="chat-container" aria-live="polite" aria-atomic="true" aria-relevant="additions">
    <div id="chat" role="log"></div>
    <div id="feedback" aria-live="assertive"></div>
    <button id="start-btn" aria-label="Start speaking">üé§ Hablar</button>
  </div>

  <script>
    // Variables globales
    const chat = document.getElementById('chat');
    const feedback = document.getElementById('feedback');
    const startBtn = document.getElementById('start-btn');
    const voiceButtons = document.querySelectorAll('#voice-select button');

    let voices = [];
    let selectedVoice = null;
    let recognition;
    let conversationState = 0; // Para controlar el flujo de la conversaci√≥n

    // Cargar voces y setear voz por defecto (Espa√±a)
    function loadVoices() {
      voices = speechSynthesis.getVoices();
      setVoice('es-ES');
    }

    // Establecer voz seg√∫n id (es-ES o es-MX)
    function setVoice(langCode) {
      const filteredVoices = voices.filter(v => v.lang.startsWith(langCode));
      // Escoger voz femenina y natural si es posible
      selectedVoice = filteredVoices.find(v => v.name.toLowerCase().includes('female') || v.name.toLowerCase().includes('maria')) || filteredVoices[0];
      if (!selectedVoice) selectedVoice = voices[0];
      console.log('Selected voice:', selectedVoice.name);
    }

    // Manejar selecci√≥n de acento y botones
    voiceButtons.forEach(button => {
      button.addEventListener('click', () => {
        voiceButtons.forEach(b => {
          b.classList.remove('selected');
          b.setAttribute('aria-pressed', 'false');
        });
        button.classList.add('selected');
        button.setAttribute('aria-pressed', 'true');
        setVoice(button.id);
      });
    });

    // Funci√≥n para a√±adir mensaje al chat
    function addMessage(text, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message');
      messageDiv.classList.add(sender === 'bot' ? 'bot-message' : 'user-message');
      messageDiv.textContent = text;
      chat.appendChild(messageDiv);
      chat.scrollTop = chat.scrollHeight;
    }

    // Funci√≥n para hablar un texto con la voz seleccionada
    function speak(text) {
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.voice = selectedVoice;
      utterance.lang = selectedVoice.lang;
      speechSynthesis.speak(utterance);
    }

    // Funci√≥n para iniciar reconocimiento de voz
    function startRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('Lo siento, tu navegador no soporta reconocimiento de voz.');
        return;
      }
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = selectedVoice.lang || 'es-ES';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.start();
      startBtn.disabled = true;
      startBtn.textContent = 'üéô Escuchando...';

      recognition.onresult = (event) => {
        const speechResult = event.results[0][0].transcript.trim();
        addMessage(speechResult, 'user');
        handleResponse(speechResult.toLowerCase());
      };

      recognition.onerror = (event) => {
        feedback.textContent = "Sorry, I couldn't hear you clearly. Please try again.";
        startBtn.disabled = false;
        startBtn.textContent = 'üé§ Hablar';
      };

      recognition.onend = () => {
        startBtn.disabled = false;
        startBtn.textContent = 'üé§ Hablar';
      };
    }

    // Manejar respuestas y flujo conversacional
    function handleResponse(input) {
      feedback.textContent = '';
      switch (conversationState) {
        case 0:
          if (input.includes('hola') || input.includes('buenos d√≠as') || input.includes('buenas tardes') || input.includes('buenas noches')) {
            addMessage('¬°Mucho gusto! ¬øC√≥mo te llamas?', 'bot');
            speak('Mucho gusto! ¬øC√≥mo te llamas?');
            conversationState = 1;
          } else {
            addMessage("Please greet me with 'Hola' or 'Buenos d√≠as'.", 'bot');
            speak("Please greet me with 'Hola' or 'Buenos d√≠as'.");
            feedback.textContent = "You should start with a greeting like 'Hola' or 'Buenos d√≠as'.";
          }
          break;
        case 1:
          if (input.startsWith('me llamo ') || input.startsWith('soy ')) {
            const name = input.replace('me llamo ', '').replace('soy ', '').trim();
            addMessage(`¬°Encantado de conocerte, ${name}! ¬øDe d√≥nde eres?`, 'bot');
            speak(`Encantado de conocerte, ${name}! ¬øDe d√≥nde eres?`);
            conversationState = 2;
          } else if (input === 'y t√∫' || input === '¬øy t√∫?') {
            addMessage("¬°Me llamo Atlas! ¬øDe d√≥nde eres?", 'bot');
            speak("Me llamo Atlas! ¬øDe d√≥nde eres?");
          } else {
            addMessage("Please tell me your name by saying 'Me llamo ...' or 'Soy ...'", 'bot');
            speak("Please tell me your name by saying 'Me llamo' or 'Soy'.");
            feedback.textContent = "Use: Me llamo [your name] or Soy [your name]";
          }
          break;
        case 2:
          if (input.startsWith('soy de ') || input.startsWith('de ')) {
            const place = input.replace('soy de ', '').replace('de ', '').trim();
            addMessage(`¬°Qu√© bien! Yo soy de Espa√±a. ¬øCu√°ntos a√±os tienes?`, 'bot');
            speak(`Qu√© bien! Yo soy de Espa√±a. ¬øCu√°ntos a√±os tienes?`);
            conversationState = 3;
          } else if (input === 'y t√∫' || input === '¬øy t√∫?') {
            addMessage("Soy de Espa√±a. ¬øCu√°ntos a√±os tienes?", 'bot');
            speak("Soy de Espa√±a. ¬øCu√°ntos a√±os tienes?");
          } else {
            addMessage("Please say where you are from using 'Soy de ...' or 'De ...'", 'bot');
            speak("Please say where you are from using 'Soy de' or 'De'.");
            feedback.textContent = "Use: Soy de [place] or De [place]";
          }
          break;
        case 3:
          const ageMatch = input.match(/\d+/);
          if (ageMatch) {
            const age = ageMatch[0];
            addMessage(`¬°Genial! Tengo ${age} a√±os tambi√©n. ¬øC√≥mo est√°s hoy?`, 'bot');
            speak(`Genial! Tengo ${age} a√±os tambi√©n. ¬øC√≥mo est√°s hoy?`);
            conversationState = 4;
          } else if (input === 'y t√∫' || input === '¬øy t√∫?') {
            addMessage("Estoy bien, gracias. ¬øY t√∫?", 'bot');
            speak("Estoy bien, gracias. ¬øY t√∫?");
          } else {
            addMessage("Please tell me your age as a number, for example: 'Tengo 20 a√±os'.", 'bot');
            speak("Please tell me your age as a number, for example: 'Tengo veinte a√±os'.");
            feedback.textContent = "Your answer needs to include a number.";
          }
          break;
        case 4:
          if (input.includes('bien') || input.includes('muy bien') || input.includes('estoy bien')) {
            addMessage("¬°Me alegro! ¬øCu√°l es tu d√≠a favorito de la semana?", 'bot');
            speak("Me alegro! ¬øCu√°l es tu d√≠a favorito de la semana?");
            conversationState = 5;
          } else if (input.includes('mal') || input.includes('no bien') || input.includes('estoy mal')) {
            addMessage("Lo siento. Espero que tu d√≠a mejore. ¬øCu√°l es tu d√≠a favorito de la semana?", 'bot');
            speak("Lo siento. Espero que tu d√≠a mejore. ¬øCu√°l es tu d√≠a favorito de la semana?");
            conversationState = 5;
          } else if (input === 'y t√∫' || input === '¬øy t√∫?') {
            addMessage("Estoy bien, gracias.", 'bot');
            speak("Estoy bien, gracias.");
          } else {
            addMessage("Please answer with 'Estoy bien' or 'Estoy mal'.", 'bot');
            speak("Please answer with 'Estoy bien' or 'Estoy mal'.");
            feedback.textContent = "Try to say: Estoy bien or Estoy mal.";
          }
          break;
        case 5:
          const days = ['lunes', 'martes', 'mi√©rcoles', 'miercoles', 'jueves', 'viernes', 's√°bado', 'sabado', 'domingo'];
          if (days.some(day => input.includes(day))) {
            addMessage("¬°Excelente elecci√≥n! Gracias por practicar conmigo. ¬°Hasta luego!", 'bot');
            speak("Excelente elecci√≥n! Gracias por practicar conmigo. Hasta luego!");
            conversationState = 6;
          } else if (input === 'y t√∫' || input === '¬øy t√∫?') {
            addMessage("Mi d√≠a favorito es el viernes.", 'bot');
            speak("Mi d√≠a favorito es el viernes.");
          } else {
            addMessage("Please name a day of the week, for example: 'Mi d√≠a favorito es viernes'.", 'bot');
            speak("Please name a day of the week, for example: 'Mi d√≠a favorito es viernes'.");
            feedback.textContent = "Try naming a day like 'lunes' or 'viernes'.";
          }
          break;
        case 6:
          addMessage("¬°Conversaci√≥n terminada! Puedes refrescar la p√°gina para practicar otra vez.", 'bot');
          speak("Conversation finished! You can refresh the page to practice again.");
          feedback.textContent = '';
          break;
      }
    }

    // Inicio
    window.speechSynthesis.onvoiceschanged = () => {
      loadVoices();
    };

    startBtn.addEventListener('click', () => {
      startRecognition();
    });

    // Inicia con primer saludo para animar la conversaci√≥n
    window.onload = () => {
      addMessage("¬°Hola! Por favor, sal√∫dame para comenzar (por ejemplo: Hola, Buenos d√≠as).", 'bot');
      speak("Hola! Por favor, sal√∫dame para comenzar, por ejemplo, Hola o Buenos d√≠as.");
    };
  </script>
</body>
</html>
