<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chatbot Español - Módulo 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto Slab', serif;
      background-color: #F3EFE3;
      color: #A84339;
      max-width: 800px;
      margin: 40px auto;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(171, 109, 90, 0.2);
    }

    header {
      text-align: center;
      margin-bottom: 20px;
    }

    header img {
      max-width: 160px;
      margin-bottom: 10px;
    }

    header h1 {
      color: #CB9180;
      font-size: 1.8rem;
      margin: 0;
    }

    #chat {
      background-color: #ffffff;
      border-radius: 10px;
      padding: 20px;
      min-height: 320px;
      box-shadow: inset 0 0 10px rgba(203, 145, 128, 0.15);
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .bot-msg {
      color: #CB9180;
      margin: 12px 0;
      font-weight: 700;
    }

    .user-msg {
      color: #A84339;
      text-align: right;
      margin: 12px 0;
      font-style: italic;
    }

    #input-area {
      display: flex;
      gap: 10px;
    }

    #user-input {
      flex-grow: 1;
      padding: 10px 15px;
      font-size: 1rem;
      border: 2px solid #CB9180;
      border-radius: 8px;
      outline: none;
    }

    #send-btn, #mic-btn {
      background-color: #A84339;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }

    #send-btn:hover, #mic-btn:hover {
      background-color: #CB9180;
    }

    #feedback {
      color: #A84339;
      margin-top: 12px;
      min-height: 20px;
      font-weight: 600;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      font-size: 0.85rem;
      color: #CB9180;
    }
  </style>
</head>
<body>

  <header>
    <img src="images/Atlas_Color.png" alt="Logo Atlas Language Academy">
    <h1>Chatbot de práctica – Módulo 1: Introducciones</h1>
  </header>

  <div id="chat">
    <div class="bot-msg">¡Hola! ¿Cómo te llamas?</div>
  </div>

  <div id="input-area">
    <input type="text" id="user-input" placeholder="Escribe tu respuesta o usa el micrófono...">
    <button id="mic-btn">🎤</button>
    <button id="send-btn">Enviar</button>
  </div>

  <div id="feedback"></div>

  <footer>
    © 2025 Atlas Language Academy. Todos los derechos reservados.
  </footer>

  <script>
    const chat = document.getElementById('chat');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const micBtn = document.getElementById('mic-btn');
    const feedback = document.getElementById('feedback');

    const synth = window.speechSynthesis;
    let voices = [];

    let step = 0;

    function speak(text, lang = 'es-ES') {
      if (!voices.length) voices = synth.getVoices();
      const utter = new SpeechSynthesisUtterance(text);
      const selectedVoice = voices.find(v => v.lang === lang && v.name.includes('Google')) || voices.find(v => v.lang === lang) || voices[0];
      utter.voice = selectedVoice;
      console.log("Selected voice:", selectedVoice.name);
      synth.speak(utter);
    }

    function addMessage(text, sender) {
      const msg = document.createElement('div');
      msg.className = sender === 'user' ? 'user-msg' : 'bot-msg';
      msg.innerText = text;
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
    }

    function handleResponse(input) {
      const cleaned = input.trim().toLowerCase();
      feedback.innerText = ''; // Reset feedback

      if (cleaned.includes("tonto") || cleaned.includes("malo")) {
        addMessage("Por favor, usa un lenguaje apropiado. 🙏", 'bot');
        speak("Please use appropriate language.", 'en-US');
        return;
      }

      if (step === 0) {
        addMessage("¡Mucho gusto, " + input + "! ¿De dónde eres?", 'bot');
        speak("¡Mucho gusto, " + input + "! ¿De dónde eres?");
        step++;
      } else if (step === 1) {
        addMessage("¡Qué interesante! ¿Cuál es tu número de teléfono?", 'bot');
        speak("¡Qué interesante! ¿Cuál es tu número de teléfono?");
        step++;
      } else if (step === 2) {
        if (/[\d]{6,}/.test(cleaned)) {
          addMessage("Gracias. ¿Cuál es tu correo electrónico?", 'bot');
          speak("Gracias. ¿Cuál es tu correo electrónico?");
          step++;
        } else {
          addMessage("Ese número no es válido.", 'bot');
          const msg = "Your phone number must have at least 6 digits. Please try again.";
          feedback.innerText = msg;
          speak(msg, 'en-US');
        }
      } else if (step === 3) {
        if (cleaned.includes("@")) {
          addMessage("¡Perfecto! Fue un placer hablar contigo. ¡Hasta luego!", 'bot');
          speak("¡Perfecto! Fue un placer hablar contigo. ¡Hasta luego!");
          step++;
        } else {
          addMessage("Hmm... eso no parece un correo válido.", 'bot');
          const msg = "Your email must include '@'. Example: name@gmail.com";
          feedback.innerText = msg;
          speak(msg, 'en-US');
        }
      } else {
        addMessage("Ya hemos terminado por ahora. 😊", 'bot');
        speak("Ya hemos terminado por ahora.");
      }
    }

    sendBtn.onclick = () => {
      const input = userInput.value;
      if (!input) return;
      addMessage(input, 'user');
      userInput.value = '';
      handleResponse(input);
    };

    userInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        sendBtn.click();
      }
    });

    micBtn.onclick = () => {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'es-ES';
      recognition.start();

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        userInput.value = transcript;
        sendBtn.click();
      };

      recognition.onerror = (event) => {
        feedback.innerText = "Microphone error. Please try again.";
        speak("Microphone error. Please try again.", 'en-US');
      };
    };

    window.speechSynthesis.onvoiceschanged = () => {
      voices = synth.getVoices();
    };
  </script>

</body>
</html>
