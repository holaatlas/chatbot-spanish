<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chatbot - Atlas Language Academy</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    body {
      font-family: 'Poppins', sans-serif;
      background-color: #ffffff;
      color: #0A2540;
      max-width: 700px;
      margin: 40px auto;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(10, 37, 64, 0.1);
    }

    h1 {
      text-align: center;
      color: #0077B6;
      margin-bottom: 25px;
      font-size: 2rem;
    }

    #chat {
      background-color: #F5F8FA;
      border-radius: 10px;
      padding: 20px;
      min-height: 320px;
      box-shadow: inset 0 0 10px rgba(0, 119, 182, 0.08);
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .bot-msg {
      color: #0077B6;
      margin: 12px 0;
      font-weight: 600;
    }

    .user-msg {
      color: #0A2540;
      text-align: right;
      margin: 12px 0;
      font-style: italic;
    }

    #input-area {
      display: flex;
      gap: 10px;
    }

    #user-input {
      flex-grow: 1;
      padding: 10px 15px;
      font-size: 1rem;
      border: 2px solid #0077B6;
      border-radius: 8px;
      outline: none;
    }

    #send-btn, #mic-btn {
      background-color: #0077B6;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }

    #send-btn:hover, #mic-btn:hover {
      background-color: #023E8A;
    }

    #feedback {
      color: #D32F2F;
      margin-top: 12px;
      min-height: 20px;
      font-weight: 600;
    }
  </style>
</head>
<body>

<h1>Chatbot de Bienvenida</h1>
<div id="chat"></div>

<div id="input-area">
  <input id="user-input" type="text" placeholder="Escribe tu respuesta aquÃ­..." autocomplete="off" />
  <button id="send-btn">Enviar</button>
  <button id="mic-btn" title="Hablar con el chatbot">ðŸŽ¤</button>
</div>

<div id="feedback"></div>

<script>
  const chat = document.getElementById("chat");
  const userInput = document.getElementById("user-input");
  const sendBtn = document.getElementById("send-btn");
  const micBtn = document.getElementById("mic-btn");
  const feedbackDiv = document.getElementById("feedback");

  const synth = window.speechSynthesis;
  let selectedVoice = null;

  function speak(text) {
    if (!selectedVoice) return;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.voice = selectedVoice;
    utterance.lang = 'es-ES';
    synth.speak(utterance);
  }

  function addMessage(text, sender) {
    const div = document.createElement("div");
    div.textContent = text;
    div.className = sender === "bot" ? "bot-msg" : "user-msg";
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  let step = 0;
  let studentName = "";

  const conversation = [
    {
      question: "Â¡Hola! Â¿CÃ³mo te llamas?",
      validator: (input) => {
        const lower = input.toLowerCase();
        if (lower.includes("me llamo") || lower.includes("soy") || lower.includes("mi nombre es")) {
          const words = input.trim().split(" ");
          studentName = words[words.length - 1];
          return { valid: true };
        }
        return { valid: false, feedback: "Di: 'Me llamo Ana' o 'Soy Ana'." };
      }
    },
    {
      question: () => `Mucho gusto, ${studentName}. Â¿De dÃ³nde eres?`,
      validator: (input) => {
        const lower = input.toLowerCase();
        return lower.includes("soy de") || lower.includes("vengo de")
          ? { valid: true }
          : { valid: false, feedback: "Ejemplo: 'Soy de MÃ©xico'." };
      }
    },
    {
      question: "Â¿CÃ³mo estÃ¡s hoy?",
      validator: (input) => {
        const validPhrases = ["estoy bien", "estoy mal", "estoy mÃ¡s o menos", "bien", "mal"];
        return validPhrases.some(p => input.toLowerCase().includes(p))
          ? { valid: true }
          : { valid: false, feedback: "Puedes decir: 'Estoy bien', 'Estoy mal'..." };
      }
    },
    {
      question: "Â¿Te gusta aprender espaÃ±ol?",
      validator: (input) => {
        return input.toLowerCase().includes("sÃ­") || input.toLowerCase().includes("no")
          ? { valid: true }
          : { valid: false, feedback: "Responde con 'SÃ­' o 'No'." };
      }
    },
    {
      question: () => `Gracias por compartir, ${studentName}. Â¿Quieres seguir practicando?`,
      validator: (input) => {
        const lower = input.toLowerCase();
        if (lower.includes("sÃ­")) return { valid: true };
        if (lower.includes("no")) return { valid: true, end: true };
        return { valid: false, feedback: "Responde 'SÃ­' o 'No'." };
      }
    },
    {
      question: "Â¡Genial! Â¿CuÃ¡l es tu color favorito?",
      validator: () => ({ valid: true })
    },
    {
      question: () => `Â¡Fue un placer, ${studentName}! Hasta luego.`,
      validator: null
    }
  ];

  function showQuestion() {
    feedbackDiv.textContent = "";
    let current = conversation[step];
    let qText = typeof current.question === "function" ? current.question() : current.question;
    addMessage(qText, "bot");
    speak(qText);
  }

  function checkAnswer(input) {
    let current = conversation[step];
    if (!current.validator) {
      addMessage("Gracias por practicar. Â¡Hasta luego!", "bot");
      return;
    }

    let result = current.validator(input);
    if (result.valid) {
      addMessage(input, "user");
      if (result.end) {
        addMessage("Gracias por practicar. Â¡Nos vemos!", "bot");
        speak("Gracias por practicar. Â¡Nos vemos!");
        return;
      }
      step++;
      setTimeout(() => {
        if (step < conversation.length) {
          showQuestion();
        }
      }, 700);
      feedbackDiv.textContent = "";
    } else {
      feedbackDiv.textContent = result.feedback;
      addMessage(result.feedback, "bot");
      speak(result.feedback);
    }
  }

  sendBtn.addEventListener("click", () => {
    let input = userInput.value.trim();
    if (input) {
      checkAnswer(input);
      userInput.value = "";
    }
  });

  userInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendBtn.click();
  });

  micBtn.addEventListener("click", () => {
    if (!("webkitSpeechRecognition" in window || "SpeechRecognition" in window)) {
      alert("Tu navegador no soporta reconocimiento de voz.");
      return;
    }

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = "es-ES";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.start();

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      checkAnswer(transcript);
    };

    recognition.onerror = () => {
      alert("Error al reconocer tu voz. Intenta de nuevo.");
    };
  });

  window.speechSynthesis.onvoiceschanged = () => {
    const voices = window.speechSynthesis.getVoices();
    selectedVoice =
      voices.find(v => v.lang === "es-ES" && /female|maria|mona|paola/i.test(v.name)) ||
      voices.find(v => v.lang === "es-ES");

    console.log("Voz seleccionada:", selectedVoice?.name);
    showQuestion();
  };
</script>

</body>
</html>
